require 'spec_helper'

describe Bitcoin::Message::CmpctBlock do

  describe '#parse_from_payload' do
    subject {
      Bitcoin::Message::CmpctBlock.parse_from_payload('0000002033781a817676c59166524c3a69b9fd3a9b2a6ed044ebdf7f4c040000000000000fbd4c2e418d224f14a9d7a98b7e1f209c2a0ab012753de877f7af00b73b5a65590e745affff001d2812f96dc234b7b2ee94be6d74b58154f3275ec256d99867579a521d662b97d412dcfb23573c433ff9eb66ef96c86970ebf38e4c46389307ea568f63e2967eececb9d6897ea96d5febb7c850c557795c15f5bf20516a87172d8270427e0793539ffafa25be31d7ec86f5b48966c24e56c9e6a1ab9b142a8c4b7128a79e9ef2cf2138a25ca645947c9824eb96ef751bf617e747abca767c4ea996c8595f2c0ea73f2569a772818902e0a8900851cae1b87fcb352e999f4f47ed2ed2b098afb50c90c5b1b2dfa95859d0084e36c9e7dffa15d4cdc7f3eb0bae27e3f2bbe7cad5d3d0a04b04571d0448891195fd4cce0aedf9361da04fd8cc316159f669ab95e892a4e049a4b04755222a8c7210a223439868e1522662c3cb5d20491f3813952bd0521a8395e385697a0124093185daf5fd8a353e68d8f3f145f6ed2e4b8d5c91be3d009ff00c13aa415e8e0c4555935f9c9c5097d8b69f7a84933be4f56f303c77d91b246d65ac75f05e0cb84a65fe207940bc35b918abebd1780bf7c382116eac7671874ec93ee5e3be54ac9de10d45f7167b7709f28cfc23d88d760638bc17b746a88ae274f7281ed36a2adb8fdb4ed23a5be2a3176e705e5255a1f80ac7ad8771694f520e5407449b73fa876133dc1c8b3d4e35ba8fb209cc45243f6f915ca8d6ba91296566284999c39a63ad87d127cc1bf3b63357518113836abbd182756d8f8f52c51a9aca2cdcf35fb7aa5b5d18926d4e9a6057ba852f1f675ae59e1b292be61c177bea4ce9879823d360e4ca1fb961bc8354df62857de0df427eb75cb7a7ef160f9c0a66fbcef6050af9ffa5a3c66e7deebaa63ee3a2709ce27b3937f155093c4d3582a0eb6228792e8f6a6298197bba3acaf3e939f1998fa48c9e319a47cbf414a64a93451d25d765e8d9f7631035e158aa269858f5c94cc4504abd63d8e086bbc7a744de182b0db9901e576a691f2b27cede754873eed1292e5e68f73341cab660010001000000010000000000000000000000000000000000000000000000000000000000000000ffffffff23032c411300fe590e745afe4c2505000963676d696e6572343208000000000000000000ffffffff020c7a0e05000000001976a914f2c25ac3d59f3d674b1d1d0a25c27339aaac0ba688ac0000000000000000266a24aa21a9ed7e6376ac601ad46e980fcfa343c8e537c09f6fa3be869af422bb34c08c11599800000000'.htb)
    }
    it 'should be parsed.' do
      expect(subject.header_and_short_ids.header.hash).to eq('86547c8cd55adcb3532c150c225e0167d1b9f26976535cfa3abd4b4c00000000')
      expect(subject.header_and_short_ids.header.to_payload.bth).to eq('0000002033781a817676c59166524c3a69b9fd3a9b2a6ed044ebdf7f4c040000000000000fbd4c2e418d224f14a9d7a98b7e1f209c2a0ab012753de877f7af00b73b5a65590e745affff001d2812f96d')
      expect(subject.header_and_short_ids.nonce).to eq(7907921748630648002)
      expect(subject.header_and_short_ids.short_ids[0]).to eq(103525679137205)
      expect(subject.header_and_short_ids.short_ids[1]).to eq(96102457628354)
      expect(subject.header_and_short_ids.short_ids.size).to eq(116)
      expect(subject.header_and_short_ids.prefilled_txn.size).to eq(1)
      expect(subject.header_and_short_ids.prefilled_txn.first.index).to eq(0)
      expect(subject.header_and_short_ids.siphash_key.bth).to eq('d03951189c0458515f041d233adbb3cf')
      expect(subject.header_and_short_ids.prefilled_txn.first.tx.txid).to eq('dc45f5df3946987d1c12f64a58dc7e76882c81e220d933ea13394f1dce425831')
      expect(subject.to_payload.bth).to eq('0000002033781a817676c59166524c3a69b9fd3a9b2a6ed044ebdf7f4c040000000000000fbd4c2e418d224f14a9d7a98b7e1f209c2a0ab012753de877f7af00b73b5a65590e745affff001d2812f96dc234b7b2ee94be6d74b58154f3275ec256d99867579a521d662b97d412dcfb23573c433ff9eb66ef96c86970ebf38e4c46389307ea568f63e2967eececb9d6897ea96d5febb7c850c557795c15f5bf20516a87172d8270427e0793539ffafa25be31d7ec86f5b48966c24e56c9e6a1ab9b142a8c4b7128a79e9ef2cf2138a25ca645947c9824eb96ef751bf617e747abca767c4ea996c8595f2c0ea73f2569a772818902e0a8900851cae1b87fcb352e999f4f47ed2ed2b098afb50c90c5b1b2dfa95859d0084e36c9e7dffa15d4cdc7f3eb0bae27e3f2bbe7cad5d3d0a04b04571d0448891195fd4cce0aedf9361da04fd8cc316159f669ab95e892a4e049a4b04755222a8c7210a223439868e1522662c3cb5d20491f3813952bd0521a8395e385697a0124093185daf5fd8a353e68d8f3f145f6ed2e4b8d5c91be3d009ff00c13aa415e8e0c4555935f9c9c5097d8b69f7a84933be4f56f303c77d91b246d65ac75f05e0cb84a65fe207940bc35b918abebd1780bf7c382116eac7671874ec93ee5e3be54ac9de10d45f7167b7709f28cfc23d88d760638bc17b746a88ae274f7281ed36a2adb8fdb4ed23a5be2a3176e705e5255a1f80ac7ad8771694f520e5407449b73fa876133dc1c8b3d4e35ba8fb209cc45243f6f915ca8d6ba91296566284999c39a63ad87d127cc1bf3b63357518113836abbd182756d8f8f52c51a9aca2cdcf35fb7aa5b5d18926d4e9a6057ba852f1f675ae59e1b292be61c177bea4ce9879823d360e4ca1fb961bc8354df62857de0df427eb75cb7a7ef160f9c0a66fbcef6050af9ffa5a3c66e7deebaa63ee3a2709ce27b3937f155093c4d3582a0eb6228792e8f6a6298197bba3acaf3e939f1998fa48c9e319a47cbf414a64a93451d25d765e8d9f7631035e158aa269858f5c94cc4504abd63d8e086bbc7a744de182b0db9901e576a691f2b27cede754873eed1292e5e68f73341cab660010001000000010000000000000000000000000000000000000000000000000000000000000000ffffffff23032c411300fe590e745afe4c2505000963676d696e6572343208000000000000000000ffffffff020c7a0e05000000001976a914f2c25ac3d59f3d674b1d1d0a25c27339aaac0ba688ac0000000000000000266a24aa21a9ed7e6376ac601ad46e980fcfa343c8e537c09f6fa3be869af422bb34c08c11599800000000')
    end
  end

  describe '#from_block' do
    let(:block) {
      Bitcoin::Message::Block.parse_from_payload(load_block('000000004c4bbd3afa5c537669f2b9d167015e220c152c53b3dc5ad58c7c5486').htb).to_block
    }

    context 'version 1' do
      subject {
        Bitcoin::Message::CmpctBlock.from_block(block, 1, 7907921748630648002)
      }
      it 'should generate CmpctBlock.' do
        expect(subject.header_and_short_ids.short_ids[0]).to eq(103525679137205)
        expect(subject.header_and_short_ids.short_ids[1]).to eq(96102457628354)
        expect(subject.header_and_short_ids.short_ids[2]).to eq(166212652585626)
        expect(subject.header_and_short_ids.short_ids[3]).to eq(95812060975828)
        expect(subject.header_and_short_ids.short_ids[21]).to eq(26345790107542)
        expect(subject.header_and_short_ids.short_ids.size).to eq(116)
        expect(subject.header_and_short_ids.prefilled_txn.size).to eq(1)
        expect(subject.to_payload.bth).to eq('0000002033781a817676c59166524c3a69b9fd3a9b2a6ed044ebdf7f4c040000000000000fbd4c2e418d224f14a9d7a98b7e1f209c2a0ab012753de877f7af00b73b5a65590e745affff001d2812f96dc234b7b2ee94be6d74b58154f3275ec256d99867579a521d662b97d412dcfb23573c433ff9eb66ef96c86970ebf38e4c46389307ea568f63e2967eececb9d6897ea96d5febb7c850c557795c15f5bf20516a87172d8270427e0793539ffafa25be31d7ec86f5b48966c24e56c9e6a1ab9b142a8c4b7128a79e9ef2cf2138a25ca645947c9824eb96ef751bf617e747abca767c4ea996c8595f2c0ea73f2569a772818902e0a8900851cae1b87fcb352e999f4f47ed2ed2b098afb50c90c5b1b2dfa95859d0084e36c9e7dffa15d4cdc7f3eb0bae27e3f2bbe7cad5d3d0a04b04571d0448891195fd4cce0aedf9361da04fd8cc316159f669ab95e892a4e049a4b04755222a8c7210a223439868e1522662c3cb5d20491f3813952bd0521a8395e385697a0124093185daf5fd8a353e68d8f3f145f6ed2e4b8d5c91be3d009ff00c13aa415e8e0c4555935f9c9c5097d8b69f7a84933be4f56f303c77d91b246d65ac75f05e0cb84a65fe207940bc35b918abebd1780bf7c382116eac7671874ec93ee5e3be54ac9de10d45f7167b7709f28cfc23d88d760638bc17b746a88ae274f7281ed36a2adb8fdb4ed23a5be2a3176e705e5255a1f80ac7ad8771694f520e5407449b73fa876133dc1c8b3d4e35ba8fb209cc45243f6f915ca8d6ba91296566284999c39a63ad87d127cc1bf3b63357518113836abbd182756d8f8f52c51a9aca2cdcf35fb7aa5b5d18926d4e9a6057ba852f1f675ae59e1b292be61c177bea4ce9879823d360e4ca1fb961bc8354df62857de0df427eb75cb7a7ef160f9c0a66fbcef6050af9ffa5a3c66e7deebaa63ee3a2709ce27b3937f155093c4d3582a0eb6228792e8f6a6298197bba3acaf3e939f1998fa48c9e319a47cbf414a64a93451d25d765e8d9f7631035e158aa269858f5c94cc4504abd63d8e086bbc7a744de182b0db9901e576a691f2b27cede754873eed1292e5e68f73341cab6600100010000000001010000000000000000000000000000000000000000000000000000000000000000ffffffff23032c411300fe590e745afe4c2505000963676d696e6572343208000000000000000000ffffffff020c7a0e05000000001976a914f2c25ac3d59f3d674b1d1d0a25c27339aaac0ba688ac0000000000000000266a24aa21a9ed7e6376ac601ad46e980fcfa343c8e537c09f6fa3be869af422bb34c08c1159980120000000000000000000000000000000000000000000000000000000000000000000000000')
      end
    end

    context 'version 2' do
      subject {
        Bitcoin::Message::CmpctBlock.from_block(block, 2, 7907921748630648002)
      }
      it 'should generate CmpctBlock.' do
        expect(subject.header_and_short_ids.short_ids[0]).to eq(215494140043210)
        expect(subject.header_and_short_ids.short_ids[1]).to eq(79218907461570)
        expect(subject.header_and_short_ids.short_ids[2]).to eq(134713034843950)
        expect(subject.header_and_short_ids.short_ids[3]).to eq(277601475003036)
        expect(subject.header_and_short_ids.short_ids[21]).to eq(26345790107542)
        expect(subject.header_and_short_ids.short_ids.size).to eq(116)
        expect(subject.header_and_short_ids.prefilled_txn.size).to eq(1)
        expect(subject.to_payload.bth).to eq('0000002033781a817676c59166524c3a69b9fd3a9b2a6ed044ebdf7f4c040000000000000fbd4c2e418d224f14a9d7a98b7e1f209c2a0ab012753de877f7af00b73b5a65590e745affff001d2812f96dc234b7b2ee94be6d74ca1faba3fdc3c2b7d6960c482ea79652857a9c824e217afcec5b9fddea5d9db03cf88d12b1a9220d452364274bcf206c1c52d5ddcb1f941be4dacf045c37d58245b6af28a22a90e243276ea7e19494fc456235d2e370ec6528f4d2d90da047efeb02fb38dd9c0cfab69caa88bff88670c588b49fb4e5450545947c9824eb96ef751bf617e747abca767c4ea996c8595f2c0ea73f2569a772818902e0a8900851cae1b87fcb352e999f4f47ed2ed2b098afb50c90c5b1b2dfa95859d0084e36c9e7dffa15d4cdc7f3eb0bae27e3f2bbe7cad5d3d0a04b04571d0448891195fd4cce0aedf9361da04fd8cc316159f669ab95e892a4e049a4b04755222a8c7210a223439868e1522662c3cb5d20491f3813952bd0521a8395e385697a0124093185daf5fd8a353e68d8f3f145f6ed2e4b8d5c91be3d009ff00c13aa415e8e0c4555935f9c9c5097d8b69f7a84933be4f56f303c77d91b246d65ac75f05e0cb84a65fe207940bc35b918abebd1780bf7c382116eac7671874ec93ee5e3be54ac9de10d45f7167b7709f28cfc23d88d760638bc17b746a88ae274f7281ed36a2adb8fdb4ed23a5be2a3176e705e5255a1f80ac7ad8771694f36917c4f09ac73fa876133dc1c8b3d4e35ba8fb209cc45243f6f915ca8d6ba91296566289867e649f7898d393dcfb0b0787d58c9aadc836abbd182756d8f8f52c51a9aca2cdcf35f6a225e04477d6d4e9a6057ba852f1f675ae59e1b292be61c177bea4ce9879823d360e4ca1fb961bc835442488a8c538fe450e94971641e091e8275ab7b4c711695ccffa5a3c66e7deebaa63ee3a2709ce27b393795e59b554c10a4e18e3673ebfda47ff7ccf57bba3acaf3e93f31862ce7e99e319a47cbf414a64a93451d25d765e8d9f7631035e158aa269858f5c94cc4504abd63d8e086bbc7a744312f3a473d5d1e576a691f2b27cede754873eed1292e5e680aa28929cffd0100010000000001010000000000000000000000000000000000000000000000000000000000000000ffffffff23032c411300fe590e745afe4c2505000963676d696e6572343208000000000000000000ffffffff020c7a0e05000000001976a914f2c25ac3d59f3d674b1d1d0a25c27339aaac0ba688ac0000000000000000266a24aa21a9ed7e6376ac601ad46e980fcfa343c8e537c09f6fa3be869af422bb34c08c1159980120000000000000000000000000000000000000000000000000000000000000000000000000')
      end
    end

    context 'unsupported version' do
      it 'should raise error.' do
        expect{Bitcoin::Message::CmpctBlock.from_block(block, 3, 7907921748630648002)}.to raise_error('Unsupported version.')
      end
    end
  end

end
